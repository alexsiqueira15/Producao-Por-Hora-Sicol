<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>ACORDINHO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color:#f8f9fa; text-align:center; }
        .container { max-width:900px; margin-top:30px; }
        h1 { color:#0d6efd; font-weight:bold; }
        .list-group-item { display:flex; justify-content:space-between; }
        .turno-titulo { background:#0d6efd; color:white; padding:8px; border-radius:6px; margin-top:25px; margin-bottom:10px; }
        .total-turno { font-weight:bold; margin-bottom:20px; }
        #resultado { margin-top:25px; }
        .btn { width:45%; margin:5px; }
        footer { font-size:14px; color:#6c757d; }
        canvas { margin-top:20px; max-width:100%; }
    </style>
</head>
<body>
<div class="container shadow p-4 bg-white rounded">
    <h1>Produ√ß√£o Por Hora</h1>
    <form id="form-analisar">
        <div class="mb-3 text-start">
            <label for="equipe" class="form-label fw-bold">Equipe:</label>
            <select class="form-select text-center" id="equipe" name="equipe" required>
                <option value="variavel">Vari√°vel</option>
            </select>
        </div>
        <div class="mb-3 text-start">
            <label for="planilha" class="form-label fw-bold">Envie a planilha:</label>
            <input type="file" class="form-control text-center" id="planilha" name="planilha" accept=".xlsx,.csv,.xls,.txt" required>
        </div>
        <div class="d-flex justify-content-center">
            <button type="submit" class="btn btn-primary">Analisar</button>
            <button type="button" id="limpar" class="btn btn-secondary">Limpar</button>
        </div>
    </form>
    <hr>
    <div id="resultado"></div>

    <canvas id="graficoComparativo"></canvas>
    <canvas id="graficoBarras"></canvas>
    <canvas id="graficoPizza"></canvas>
</div>

<script>
let graficoComparativo = null;
let graficoBarras = null;
let graficoPizza = null;

document.getElementById('form-analisar').addEventListener('submit', async function(e){
    e.preventDefault();
    let div = document.getElementById('resultado');
    div.innerHTML = `<div class="alert alert-info">üîç Analisando...</div>`;

    // üîπ Se houver gr√°ficos anteriores, destruir antes de criar novos
    if (graficoComparativo) { graficoComparativo.destroy(); graficoComparativo = null; }
    if (graficoBarras) { graficoBarras.destroy(); graficoBarras = null; }
    if (graficoPizza) { graficoPizza.destroy(); graficoPizza = null; }

    let formData = new FormData(this);
    let res = await fetch('/analisar',{method:'POST', body:formData});
    let data = await res.json();

    if(data.error){ 
        div.innerHTML = `<div class="alert alert-danger">${data.error}</div>`; 
        return; 
    }

    div.innerHTML = `<div class="alert alert-success">‚úÖ An√°lise conclu√≠da com sucesso!</div>`;
    div.innerHTML += `<h3 class="mb-3 text-primary fw-bold">Total Geral de Acordos: ${data.total}</h3>`;

    // === Montar listas de resultados e preparar dados para gr√°ficos ===
    const turnoLabels = [];
    const turnoValores = [];
    const operadorLabels = new Set();
    const operadoresPorTurno = {};

    for(let turno in data.turnos){
        let operadores = data.turnos[turno];
        operadoresPorTurno[turno] = operadores;
        let html = `<div class="turno-titulo"><h5>${turno}</h5></div><ul class="list-group mb-2 mx-auto" style="max-width:500px;">`;
        let totalTurno = 0;

        for (let operador in operadores) {
            let qtd = operadores[operador];
            totalTurno += qtd;
            html += `<li class="list-group-item">${operador} <span class="badge bg-primary rounded-pill">${qtd}</span></li>`;
            operadorLabels.add(operador);
        }
        html += `</ul><p class="total-turno">Total do turno ${turno}: <span class="text-primary">${totalTurno}</span></p>`;
        div.innerHTML += html;

        turnoLabels.push(turno);
        turnoValores.push(totalTurno);
    }

    // === Bot√£o de download ===
    if(data.file_id){
        const btn = document.createElement('button');
        btn.className = "btn btn-success mt-4";
        btn.innerHTML = "üì• Baixar em Excel";
        btn.onclick = () => { window.location.href = '/download/' + data.file_id; };
        div.appendChild(btn);
    }

    // === Gr√°fico comparativo (barras agrupadas) ===
    const ctxComparativo = document.getElementById('graficoComparativo').getContext('2d');
    const labelsOperadores = Array.from(operadorLabels);
    const datasetsComparativo = Object.keys(operadoresPorTurno).map((turno, i) => {
        const cor = ['#0d6efd', '#ffc107', '#198754', '#dc3545'][i % 4];
        return {
            label: turno,
            data: labelsOperadores.map(op => operadoresPorTurno[turno][op] || 0),
            backgroundColor: cor
        };
    });

    graficoComparativo = new Chart(ctxComparativo, {
        type: 'bar',
        data: { labels: labelsOperadores, datasets: datasetsComparativo },
        options: {
            responsive: true,
            plugins: { title: { display: true, text: 'Comparativo por Operador e Turno' } },
            scales: { x: { stacked: false }, y: { beginAtZero: true } }
        }
    });

    // === Gr√°fico de barras (todos os operadores juntos) ===
    const operadorLabelsSimples = [];
    const operadorValoresSimples = [];
    for(let turno in data.turnos){
        for(let operador in data.turnos[turno]){
            operadorLabelsSimples.push(`${turno} - ${operador}`);
            operadorValoresSimples.push(data.turnos[turno][operador]);
        }
    }

    const ctx1 = document.getElementById('graficoBarras').getContext('2d');
    graficoBarras = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: operadorLabelsSimples,
            datasets: [{
                label: 'Acordos por Operador',
                data: operadorValoresSimples,
                backgroundColor: '#0d6efd'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Desempenho Geral por Operador' }
            },
            scales: {
                x: { ticks: { autoSkip: false, maxRotation: 90, minRotation: 60 } },
                y: { beginAtZero: true }
            }
        }
    });

    // === Gr√°fico de pizza por turno ===
    const ctx2 = document.getElementById('graficoPizza').getContext('2d');
    graficoPizza = new Chart(ctx2, {
        type: 'pie',
        data: {
            labels: turnoLabels,
            datasets: [{
                label: 'Acordos por Turno',
                data: turnoValores,
                backgroundColor: ['#0d6efd', '#ffc107', '#198754', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'Distribui√ß√£o de Acordos por Turno' }
            }
        }
    });
});

// üîπ Bot√£o limpar agora tamb√©m destr√≥i gr√°ficos
document.getElementById('limpar').addEventListener('click', function(){
    document.getElementById('resultado').innerHTML='';
    if (graficoComparativo) { graficoComparativo.destroy(); graficoComparativo = null; }
    if (graficoBarras) { graficoBarras.destroy(); graficoBarras = null; }
    if (graficoPizza) { graficoPizza.destroy(); graficoPizza = null; }
    document.getElementById('form-analisar').reset();
});
</script>
</body>
</html>
